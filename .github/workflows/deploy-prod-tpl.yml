# .github/workflows/deploy-prod-tpl.yml
on:
  workflow_call:
    inputs:
      Environment:
        required: true
        type: string
      region:
        required: true
        type: string    
         
    secrets:
      role:
        required: true


permissions:
  id-token: write
  pull-requests: read
  contents: read
  issues: write

jobs:
  validate:
    if: github.event.pull_request.merged == true
    environment:  ${{ inputs.Environment }}
    name: Linting ${{ inputs.Environment }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
  
      - name: Install cfn-lint
        run: pip install cfn-lint
  
      - name: Lint CloudFormation templates
        run: |
            for template in templates/*.{yaml,yml}
            do
              if [ -f "$template" ]; then
                echo "Linting $template..."
                cfn-lint $template
              fi
            done

  create-deployment-request:
    runs-on: ubuntu-latest
    needs: validate
    environment:  ${{ inputs.Environment }}
    steps:
      - uses: actions/checkout@v4
      - name: Create Deployment Request
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Production Deployment Request - PR #${context.payload.pull_request.number}`,
              body: `
              ## Production Deployment Request
              
              PR: #${context.payload.pull_request.number}
              Branch: prod
              Author: @${context.payload.pull_request.user.login}
              
              ### Required Approvals
              - [ ] Production Lead
              - [ ] Security Lead
              - [ ] Infrastructure Lead
              
              ### Deployment Process
              1. Review the changes in PR #${context.payload.pull_request.number}
              2. Approve by checking the boxes above
              3. Comment with \`/approve-deployment\` to trigger deployment
              
              ### Change Details
              ${context.payload.pull_request.body}
              `
            });

  deploy:
    if: (github.event_name == 'issue_comment' && contains(github.event.issue.title, 'Production Deployment Request') && github.event.comment.body == '/approve-deployment')
    runs-on: ubuntu-latest
    environment:  ${{ inputs.Environment }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Verify Approvals
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            if (!issue.data.body.includes('- [x] Production Lead') ||
                !issue.data.body.includes('- [x] Security Lead') ||
                !issue.data.body.includes('- [x] Infrastructure Lead')) {
              throw new Error('Not all required approvals are in place');
            }
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.role }}
          aws-region: ${{ inputs.region }}
          
      - name: Deploy to Production
        uses: aws-actions/aws-cloudformation-github-deploy@v1
        with:
          name: "my-stack-s3-prod"
          template: ${{ github.workspace }}/templates/main.yml
          parameter-overrides: file:///${{ github.workspace }}/environments/prod/parameters.json
          capabilities: CAPABILITY_NAMED_IAM, CAPABILITY_AUTO_EXPAND
          no-fail-on-empty-changeset: "1"
     
      # step to close the issue after successful deployment
      - name: Close Deployment Request
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed',
              state_reason: 'completed'
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'âœ… Deployment completed successfully and issue automatically closed.'
            });
